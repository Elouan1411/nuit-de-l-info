<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <title>Snake</title>
    <style>
        canvas {
            border: 2px solid;
        }
    </style>
</head>

<body>
    <canvas width="400" height="400"></canvas>
    <script src="../js/core.js"></script>
    <script>
        window.onload = () => window.focus();
        window.onclick = () => window.focus();
        const canvas = document.querySelector("canvas");
        const context = canvas.getContext("2d");

        let box = 20;

        let snake = [];
        snake[0] = { x: 10 * box, y: 10 * box };

        // üîë CORRECTION: Utilise 20 pour couvrir la plage de 0 √† 19
        let food = {
            x: Math.floor(Math.random() * 20) * box,
            y: Math.floor(Math.random() * 20) * box,
        };

        let score = 0;
        let d;
        let game;

        // üîë AJOUT TEMPORAIRE : Fonction showError pour garantir que les popups fonctionnent (retirez si core.js est valide)
        function showError(title, message) {
            alert(title + "\n\n" + message);
        }

        document.addEventListener("keydown", direction);

        function direction(event) {
            let key = event.keyCode;
            if (key == 37 && d != "RIGHT") {
                d = "LEFT";
            } else if (key == 38 && d != "DOWN") {
                d = "UP";
            } else if (key == 39 && d != "LEFT") {
                d = "RIGHT";
            } else if (key == 40 && d != "UP") {
                d = "DOWN";
            }
        }

        function collision(head, array) {
            for (let g = 0; g < array.length; g++) {
                if (head.x == array[g].x && head.y == array[g].y) {
                    return true;
                }
            }
            return false;
        }

        // Encapsule l'affichage de l'√©cran d'erreur
        function displayGameOverScreen() {
            context.clearRect(0, 0, 400, 400);

            // Fond rouge pour l'effet d'erreur
            context.fillStyle = 'red';
            context.fillRect(0, 0, 400, 400);

            context.fillStyle = 'white';
            context.font = 'bold 24px Arial';
            context.textAlign = 'center';
            context.fillText("UNE ERREUR EST SURVENUE", 200, 180);
            context.font = '16px Arial';
            context.fillText("Une exception fatale 0E s'est produite au niveau du score : " + score, 200, 220);
            context.fillText("Veuillez fermer les fen√™tres contextuelles pour continuer.", 200, 250);
            context.fillText("Va jouer √† un autre jeu sur un meilleur syst√®me d'exploitation lol", 200, 280);
        }


        function draw() {

            context.clearRect(0, 0, 400, 400);

            // Dessin du serpent
            for (let i = 0; i < snake.length; i++) {
                context.fillStyle = i == 0 ? "green" : "white";
                context.fillRect(snake[i].x, snake[i].y, box, box);
                context.strokeStyle = "red";
                context.strokeRect(snake[i].x, snake[i].y, box, box);
            }

            // Dessin de la nourriture
            context.fillStyle = "orange";
            context.fillRect(food.x, food.y, box, box);

            // Calcul de la t√™te
            let snakeX = snake[0].x;
            let snakeY = snake[0].y;
            if (d == "LEFT") {
                snakeX -= box;
            } else if (d == "RIGHT") {
                snakeX += box;
            } else if (d == "UP") {
                snakeY -= box;
            } else if (d == "DOWN") {
                snakeY += box;
            }

            // Logique de jeu (nourriture/score/queue)
            if (snakeX == food.x && snakeY == food.y) {
                score++;
                food = {
                    // üîë CORRECTION: Utilise 20 pour couvrir la plage de 0 √† 19
                    x: Math.floor(Math.random() * 20) * box,
                    y: Math.floor(Math.random() * 20) * box,
                };
            } else {
                snake.pop();
            }

            let newHead = {
                x: snakeX,
                y: snakeY,
            };

            // V√©rification de la d√©faite/collision
            if (
                snakeX < 0 ||
                snakeY < 0 ||
                // La limite est 19 * box (soit 380px). Si snakeX atteint 400px (20 * box), c'est une d√©faite.
                snakeX >= 400 ||
                snakeY >= 400 ||
                collision(newHead, snake)
            ) {
                clearInterval(game);

                displayGameOverScreen();

                const errors = [
                    " Erreur de segmentation (core dumped) ", " Erreur de protection g√©n√©rale ", " M√©moire insuffisante ",
                    " Windows a effectu√© une op√©ration ill√©gale ", " Clavier introuvable - Appuyez sur F1 pour continuer ",
                    " Une erreur critique s'est produite ", " Erreur - Essayez de red√©marrer votre syst√®me ",
                    " Erreur critique - vous avez √©t√© trop mauvais et vous avez √©t√© expuls√© du jeu ",
                    " Une erreur s'est produite - Qui est le d√©veloppeur ? Henriet est-il de retour ? ",
                    " Erreur - La fen√™tre du tampon a atteint sa taille maximale ",
                    " L'utilisation de la RAM a atteint un niveau critique, veuillez essayer de red√©marrer ",
                    " Ce snake est nul. Vous en trouverez probablement un autre sur un meilleur syst√®me d'exploitation, je dis √ßa comme √ßa... ",
                    " Honte √† vous, c'est quoi ce jeu ? Vous devriez jouer √† une meilleure version, mais bon, Windows, quoi ??? ",
                ];

                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        const msg = errors[Math.floor(Math.random() * errors.length)];
                        if (typeof showError === 'function') {
                            parent.showError("Erreur syst√®me", msg);
                        }
                    }, i * 20);
                }

                return;
            }

            // Ajout de la nouvelle t√™te et affichage du score
            snake.unshift(newHead);
            context.fillStyle = "red";
            context.font = "30px Arial";
            context.fillText(score, 2 * box, 1.6 * box);
        }

        game = setInterval(draw, 100);

    </script>
</body>

</html>